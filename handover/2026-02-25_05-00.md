# Handover: Phase 2 ストレージ抽象化 GCS/R2 両対応

**日時**: 2026-02-25 05:00
**コミット**: `f169008` — Add StorageBackend trait for GCS/R2 dual support

## 完了タスク

### Phase 2: ストレージ抽象化（実装完了・デプロイ前）

- [x] `StorageBackend` trait 定義（`src/storage/mod.rs`）
- [x] `GcsBackend` 実装（`src/storage/gcs.rs` — 既存コード移動 + content_type 修正）
- [x] `R2Backend` 実装（`src/storage/r2.rs` — rust-s3 crate）
- [x] `Config` に R2 設定追加（`STORAGE_BACKEND`, `R2_BUCKET`, `R2_ACCOUNT_ID`, `R2_ACCESS_KEY`, `R2_SECRET_KEY`）
- [x] `main.rs` — ストレージ factory パターン（`STORAGE_BACKEND` env var で切替）
- [x] `files_service.rs` — `Arc<GcsClient>` → `Arc<dyn StorageBackend>`
- [x] `dvr_notifications_service.rs` — 同上
- [x] `.env` — R2 設定テンプレート追加
- [x] `cargo build --release` 成功

## 次のタスク

### 1. Cloud Run デプロイ（GCS のまま、既存動作確認）
```bash
./deploy.sh
```
- `STORAGE_BACKEND` 未設定 → デフォルトで GCS を使用（後方互換）
- ListCurrentCarInspections / ListFiles / DownloadFile が動作することを確認

### 2. R2 バケット作成 + ローカルテスト
```bash
# R2 バケット作成（Cloudflare ダッシュボード or wrangler）
# R2 API トークン作成（Object Read & Write 権限）

# ローカルテスト
STORAGE_BACKEND=r2 \
R2_BUCKET=rust-logi-files \
R2_ACCOUNT_ID=<cf-account-id> \
R2_ACCESS_KEY=<r2-access-key> \
R2_SECRET_KEY=<r2-secret-key> \
cargo run --release
```
- CreateFile / DownloadFile で R2 読み書き確認
- レイテンシ計測

### 3. GCS → R2 データ移行（rclone）
```bash
rclone sync gcs:rust-logi-files r2:rust-logi-files --progress
# ファイル数: 2,714個、総サイズ: ~128MB
```

### 4. Phase 3（CF Containers）— 別セッション
- CF Containers セットアップ
- R2 をデフォルトストレージに切替

## アーキテクチャ

```
STORAGE_BACKEND env var
  ├── "r2"  → R2Backend (rust-s3, S3互換API)
  ├── "gcs" → GcsBackend (google-cloud-storage)
  └── 未設定 + GCS_BUCKET あり → GcsBackend（後方互換）

StorageBackend trait
  ├── upload(key, data, content_type) → String
  ├── download(key) → Vec<u8>
  ├── delete(key) → ()
  ├── get_object_info(key) → ObjectInfo
  ├── rewrite_to_standard(key) → () (no-op)
  └── bucket() → &str
```

## 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `Cargo.toml` | `rust-s3` v0.35 依存追加 |
| `src/storage/mod.rs` | `StorageBackend` trait + `ObjectInfo` + モジュールハブ |
| `src/storage/gcs.rs` | **新規** `GcsBackend` (trait impl) |
| `src/storage/r2.rs` | **新規** `R2Backend` (trait impl) |
| `src/config.rs` | R2 関連 env var 5 つ追加 |
| `src/main.rs` | ストレージ factory パターン |
| `src/services/files_service.rs` | `Arc<dyn StorageBackend>` 化 |
| `src/services/dvr_notifications_service.rs` | 同上 |

## Phase 1 状況（前セッションで完了）

- Supabase 東京リージョンに DB 移行済み
- Cloud Run は Supabase に接続して本番稼働中
- ベンチマーク PASS（ListCurrentCarInspections: -34ms、ListFiles: +11ms）
