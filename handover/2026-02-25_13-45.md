# Handover: Phase 3 CF Containers デプロイ（途中）

**日時**: 2026-02-25 13:45
**計画書**: `/home/yhonda/.claude/plans/shimmering-roaming-hinton.md`

## 完了タスク

- [x] `cf-container/` プロジェクト作成（package.json, wrangler.toml, tsconfig.json, src/index.ts）
- [x] `npm install` 完了
- [x] Secrets 設定（DATABASE_URL, JWT_SECRET, R2_ACCESS_KEY, R2_SECRET_KEY）
- [x] `wrangler deploy` 成功 — カスタムドメイン `api-container.mtamaramu.com` 設定済み
- [x] instance_type を `lite` → `basic`（1/4 vCPU, 1 GiB RAM）にアップグレード
- [x] cf-grpc-proxy コード変更済み（**未デプロイ**）

## 動作確認結果

### 正常動作する RPC
- Health/Check → `SERVING`
- ListFiles → ファイル一覧返却 OK
- ListCurrentCarInspections → 車検証データ返却 OK
- ListCurrentCarInspectionFiles → ファイル紐づき返却 OK
- DownloadFile → R2 から PDF バイナリ取得 OK
- ValidateToken → 正常レスポンス OK
- DeleteFile（正常系）→ OK

### 失敗する RPC — gRPC エラーレスポンスが返る場合

**根本原因**: `container.fetch()` が gRPC エラーレスポンス（HTTP trailers-only）を処理できず、`Error: internal error; reference = xxx` をスローする

| RPC | 期待されるエラー | 実際の結果 |
|-----|-----------------|-----------|
| Login | Unauthenticated | Container Worker 例外 (Error 1101) |
| LoginWithGoogle | Unavailable | 同上 |
| SignUpWithGoogle | Unavailable | 同上 |
| GetFile (存在しないUUID) | NotFound | 同上 |
| Login (空リクエスト) | InvalidArgument | 同上 |

**パターン**: 正常レスポンス（data + OK status）→ 動作する / gRPC エラーレスポンス（Status::xxx）→ Container crash

### curl での確認
```
HTTP/2 200
content-type: application/grpc-web+proto
content-length: 0      ← ボディ空
grpc-status: 13        ← ヘッダーにエラー情報
grpc-message: Missing%20request%20message.
```
Container 内の Rust サーバーはエラーを正しく返しているが、`container.fetch()` がこのレスポンス形式で例外をスローする。

## 未デプロイの変更

### cf-grpc-proxy（ファイル変更済み・未デプロイ）

**`workers/cf-grpc-proxy/wrangler.toml`**:
```toml
# 変更済み
RUST_LOGI_PROXY_URL = "https://api-container.mtamaramu.com"
```

**`workers/cf-grpc-proxy/src/index.ts`**:
```typescript
// IAM トークンを条件付きに変更済み
if (this.env.GCP_SERVICE_ACCOUNT_JSON) {
  const idToken = await this.getOrRefreshToken();
  proxyHeaders.set('Authorization', `Bearer ${idToken}`);
}
```

### cf-container/src/index.ts
- エラーハンドリング（try/catch）追加済み・デプロイ済み

## 次のセッションでやること

### 1. gRPC エラーレスポンス問題の解決

選択肢:

**A) CF Containers の制約として受け入れ、cf-grpc-proxy で対応**
- cf-grpc-proxy が Cloud Run と Container の両方にリクエストを送り、Container が失敗したら Cloud Run にフォールバック
- 複雑で非効率

**B) Container Worker 側でレスポンスをバッファリング**
- `container.fetch()` の前に `request.clone()` し、例外発生時にリトライまたはエラー変換
- ただし `container.fetch()` 自体が例外をスローするので根本解決にならない

**C) Rust 側で gRPC エラーを正常レスポンスとして返す**
- tonic のミドルウェアで `Status::xxx` を `Ok(Response)` + エラー情報ボディに変換
- gRPC の仕様から逸脱するため非推奨

**D) CF Containers のバグとして報告し、修正を待つ**
- reference ID `6ikggnpbsv2rr300a34dpdcp` を添えて報告
- 修正まで Cloud Run を並行運用

**E) Container Worker で直接 HTTP リクエストを Container に送る（container.fetch() を使わない）**
- Container の内部 IP/ポートに直接アクセスできるか調査が必要

**推奨**: D（バグ報告）+ 当面は Cloud Run をフォールバックとして運用。正常系 RPC は Container で動作確認済みなので、バグ修正後に即座に切り替え可能。

### 2. cf-grpc-proxy のデプロイ判断
- 現状の Container では gRPC エラーが返るケースで問題があるため、cf-grpc-proxy の切り替えは保留
- wrangler.toml を Cloud Run に戻すか、Container を使うかの判断が必要

### 3. ロールバック
cf-grpc-proxy を Cloud Run に戻す場合:
```bash
cd /home/yhonda/js/nuxt_dtako_logs/cf-grpc-proxy
# wrangler.toml の RUST_LOGI_PROXY_URL を戻す
# RUST_LOGI_PROXY_URL = "https://cloudrun-backend.mtamaramu.com"
npx wrangler deploy
```

## デプロイ済みリソース

| リソース | 状態 |
|---------|------|
| Container Worker (`rust-logi-container`) | デプロイ済み・`api-container.mtamaramu.com` |
| Container イメージ | `scratch` ベース・basic インスタンス |
| R2 バケット (`rust-logi-files`) | 2,795 files / 243.6 MiB（GCS からコピー済み） |
| Cloud Run (`rust-logi`) | 稼働中・フォールバック可能 |
| cf-grpc-proxy | **Cloud Run 向けのまま**（変更は未デプロイ） |

## ファイルパス

| ファイル | 状態 |
|---------|------|
| `cf-container/package.json` | 新規作成済み |
| `cf-container/wrangler.toml` | 新規作成済み（instance_type=basic） |
| `cf-container/tsconfig.json` | 新規作成済み |
| `cf-container/src/index.ts` | 新規作成済み（エラーハンドリング付き） |
| `workers/cf-grpc-proxy/wrangler.toml` | 変更済み・**未デプロイ** |
| `workers/cf-grpc-proxy/src/index.ts` | 変更済み・**未デプロイ** |
