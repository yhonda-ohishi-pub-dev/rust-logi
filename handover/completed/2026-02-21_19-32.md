# 引き継ぎ: Rich Menu 画像アップロード 401 エラー + フロントエンド Observability 有効化

## ステータス: 画像アップロード Step 2 (PUT uploadUrl) で LINE WORKS API が 401 を返す問題が未解決

---

## 完了

- [x] **nuxt-pwa-carins Workers Logs 有効化** — `wrangler.toml` に `[observability] enabled = true, head_sampling_rate = 1` 追加・デプロイ済み
- [x] **nuxt-dtako-logs Workers Logs 有効化** — 同上
- [x] **Rich Menu 編集機能追加** — 「編集」ボタンで既存メニューのデータをフォームに読み込み、「更新」で新規作成→旧メニュー削除する方式
  - `auth-worker/src/lib/admin-rich-menu-html.ts` — `startEdit()`, `cancelEdit()` 関数追加、`handleCreateMenu()` を編集モード対応に修正
- [x] **Rich Menu 画像生成ボタン追加** — Canvas API でエリアの境界線・色分け・ラベルを描画した PNG を自動生成しアップロードする「画像生成」ボタン
  - `admin-rich-menu-html.ts` — `generateAndUploadImage()`, `currentMenus` キャッシュ追加

## 未完了

- [ ] **画像アップロード 401 エラー修正** — LINE WORKS Rich Menu 画像アップロードの Step 2 (PUT uploadUrl) で `{"code":"UNAUTHORIZED","description":"Authentication failed."}` が返る
  - Step 1 (POST /attachments) は成功し uploadUrl + fileId を取得できている
  - Step 2 の PUT で 401 が発生
  - 試したこと:
    1. Authorization ヘッダーなし (元のコード) → 401
    2. `botFetch()` 経由で Bearer token 付与 (毎回新トークン) → 401
    3. 1つの access token を全3ステップで共有 → 401
  - **次に調査すべきこと**:
    - LINE WORKS API ドキュメントの Content Upload 仕様を再確認（PUT に認証が必要か、Content-Type の要件など）
    - uploadUrl のドメイン (`storage.worksmobile.com`) が Bearer token を拒否している可能性 → Authorization ヘッダーなしで再試行
    - `scope: "bot"` が不十分な可能性 → `bot.message` スコープも追加して試行
    - Cloudflare Workers の fetch が大きな ArrayBuffer (Canvas 生成 PNG) で問題がないか確認
    - 手動 curl で直接 uploadUrl を叩いてデバッグ

## 次のアクション

- [ ] **401 の原因調査** — `auth-worker/src/lib/lineworks-bot-api.ts:214-265` の `uploadImage()` 関数
  - まず Authorization ヘッダーを除去して PUT を試す（pre-signed URL の可能性）
  - LINE WORKS Developer Console で Bot の scope 設定を確認
  - auth-worker のログ（Cloudflare Dashboard → Observability）で uploadUrl の完全な URL を確認
- [ ] LINE WORKS API 仕様書確認 — `docs/lineworks-rich-menu-api.md` と実際の API レスポンスを比較
- [ ] 参考: `auth-worker/src/handlers/api-rich-menu.ts:179-238` — `handleRichMenuImageUpload` ハンドラ

## 変更ファイル一覧

### auth-worker
| ファイル | 変更内容 |
|---------|---------|
| `src/lib/admin-rich-menu-html.ts` | 編集機能 + 画像生成ボタン追加 |
| `src/lib/lineworks-bot-api.ts` | `uploadImage()` を単一トークンで全ステップ実行に変更 |

### nuxt-pwa-carins
| ファイル | 変更内容 |
|---------|---------|
| `wrangler.toml` | `[observability]` セクション追加 |

### nuxt-dtako-logs
| ファイル | 変更内容 |
|---------|---------|
| `wrangler.toml` | `[observability]` セクション追加 |

## 注意事項

- auth-worker は全変更デプロイ済み (`auth.mtamaramu.com`)
- nuxt-pwa-carins, nuxt-dtako-logs も Observability 有効化でデプロイ済み
- 403 エラー（nuxt-pwa-carins.mtamaramu.com）は一時的な問題で自然解消した（原因不明）
- LINE WORKS Rich Menu が LINE WORKS アプリに表示されるには: メニュー作成 → 画像アップロード → デフォルト設定 の3ステップが必須
- `handover/2026-02-21_18-34.md` の Rich Menu 関連タスクもまだ有効（Bot Config UI 等の未完了タスクあり）
