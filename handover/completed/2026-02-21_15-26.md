# 引き継ぎ: WOFF SDK マルチテナント対応 — SSO設定画面からWOFF ID登録

## ステータス: バックエンド・フロントエンド全デプロイ完了 / SSO管理画面のWOFF ID入力UI未実装

---

## 完了
- [x] `migrations/00026_add_woff_id_to_sso_provider_configs.sql` — `woff_id TEXT` カラム追加、マイグレーション適用済み
- [x] `packages/logi-proto/proto/auth.proto` — `ResolveSsoProviderResponse.woff_id(7)`, `LoginWithSsoProviderRequest.access_token(5)` 追加
- [x] `packages/logi-proto/proto/sso_settings.proto` — `SsoConfigResponse.woff_id(8)`, `UpsertSsoConfigRequest.woff_id(6)` 追加
- [x] `src/services/auth_service.rs` — `resolve_sso_provider` が `woff_id` を返却、`login_with_sso_provider` が WOFF access_token フロー対応
- [x] `src/services/sso_settings_service.rs` — get/upsert/list で `woff_id` を CRUD
- [x] logi-proto v0.1.33 publish 済み（TypeScript に `woffId` フィールド含む）
- [x] rust-logi Cloud Run デプロイ済み（revision `rust-logi-00101-lv7`）
- [x] auth-worker デプロイ済み — `POST /auth/woff`（WOFF認証）、`GET /auth/woff-config`（WOFF ID解決）
- [x] auth-worker `src/handlers/woff-auth.ts` — `handleWoffAuth` + `handleWoffConfig` 実装
- [x] nuxt-pwa-carins デプロイ済み — `?woff` パラメータ検出 → WOFF SDK認証フロー
- [x] nuxt-pwa-carins `plugins/auth.client.ts` — WOFF コンテナ検出 → woff-config API → JWT 取得
- [x] nuxt-pwa-carins `server/middleware/auth.ts` — `?woff` でSSRリダイレクトスキップ

## 未完了
- [ ] **SSO管理画面に WOFF ID 入力欄を追加** — auth-worker `/admin/sso` のフォームに woff_id テキストフィールドを追加
- [ ] **WOFF App を LINE WORKS Developer Console で登録** — endpoint: `https://carins.mtamaramu.com/?lw=ohishiunyusouko&woff`
- [ ] **DB に WOFF ID を登録**（手動 or SSO管理画面から）
- [ ] **E2E 動作検証** — LINE WORKS アプリ内で WOFF URL を開き、同意画面なしでログインを確認

## 次のアクション

### 1. auth-worker SSO管理画面に WOFF ID 入力欄追加

修正が必要なファイル（全て `/home/yhonda/js/auth-worker/` 内）:

#### `src/lib/admin-html.ts`
- フォームに `WOFF ID` テキスト入力欄を追加（オプション項目）
- 設定一覧表示に `woff_id` を表示
- 編集時に既存の `woff_id` をフォームにプリフィル

#### `src/handlers/api-sso.ts`
- `handleSsoUpsert()` の request body に `woffId?: string` を追加
- gRPC `upsertConfig()` 呼び出し時に `woffId` をセット
- `handleSsoList()` の response にも `woffId` を含める（gRPC からは既に返っている）

### 2. 現在の API 実装状況

| 層 | woff_id 対応 | 状態 |
|----|-------------|------|
| DB (`sso_provider_configs`) | `woff_id TEXT` | 完了 |
| rust-logi gRPC (backend) | SELECT/INSERT/UPDATE | 完了 |
| logi-proto (TypeScript) | `woffId` フィールド | 完了 (v0.1.33) |
| auth-worker API (`api-sso.ts`) | **未対応** | request/response に woffId なし |
| auth-worker UI (`admin-html.ts`) | **未対応** | フォームに入力欄なし |

### 3. デプロイ

```bash
cd /home/yhonda/js/auth-worker
wrangler deploy
```

### 4. WOFF App 登録後の DB 設定（SSO管理画面完成前の暫定手段）

```bash
PGPASSWORD=kikuraku psql -h 127.0.0.1 -p 5432 -U postgres -d rust_logi_test \
  -c "UPDATE sso_provider_configs SET woff_id = '{WOFF_ID}' WHERE external_org_id = 'ohishiunyusouko';"
```

## 注意事項
- `external_org_id` は `ohishiunyusouko`（`ohishi` ではない）
- WOFF ID 登録前は `GET /auth/woff-config?domain=ohishiunyusouko` が 404 を返す（正常 — OAuth フォールバック）
- `woff.getProfile().domainId` が文字列（ドメイン名）か数値（ドメインID）かは未検証
- 前回の handover: `handover/2026-02-21_14-59.md` — WOFF SDK Integration 初期設計（このhandoverで上書き）
- 計画ファイル: `/home/yhonda/.claude/plans/graceful-humming-brook.md`（デプロイ計画、完了済み）
