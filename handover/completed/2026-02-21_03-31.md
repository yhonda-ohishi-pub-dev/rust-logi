# 引き継ぎ: LINE WORKS SSO OAuth 実装（Phase 1-5 完了 / Phase 6 未着手）

## ステータス: Phase 1-5 完了・全デプロイ済み / Phase 6（フロントエンド管理画面）未着手

---

## 完了
- [x] Phase 1: DB マイグレーション SQL 作成 + **実行済み**（`migrations/00024`, `00025`）
- [x] Phase 2: Proto 定義（`auth.proto` に ResolveSsoProvider/LoginWithSsoProvider、`sso_settings.proto` 新規作成）
- [x] Phase 3: Rust 実装 — `cargo build --release` + `cargo test --release` 全パス
  - [x] `src/services/auth_service.rs` — `resolve_sso_provider` + `login_with_sso_provider`
  - [x] `src/services/sso_settings_service.rs` — 汎用 SSO 設定管理サービス
  - [x] `src/services/sso_providers.rs` — Provider enum + OAuth utilities
  - [x] `src/services/lineworks_auth.rs` — AES-256-GCM 暗号化/復号
  - [x] コミット: `63153d6` Add generic SSO provider authentication (Phase 1-3)
  - [x] `.gitignore` 修正: `services/` → `/services/`（`src/services/` の新規ファイルが除外されていた問題）
- [x] Phase 3 デプロイ: Cloud Run revision `rust-logi-00098-hqg` SERVING
- [x] DB マイグレーション実行済み: `sso_provider_configs`, `roles`, `permissions`, `role_permissions` テーブル作成
- [x] Phase 4: auth-worker 変更
  - [x] `src/handlers/lineworks-redirect.ts` — LINE WORKS アドレスからドメイン抽出 → ResolveSsoProvider → authorize URL リダイレクト
  - [x] `src/handlers/lineworks-callback.ts` — state検証 → LoginWithSsoProvider → JWT取得 → フロントエンドリダイレクト
  - [x] `src/lib/html.ts` — LINE WORKS アドレス入力フィールド追加（緑ボタン）
  - [x] `src/handlers/login-page.ts` — `lineworksRedirectUrl` パラメータ追加
  - [x] `src/index.ts` — `/oauth/lineworks/redirect`, `/oauth/lineworks/callback` ルート追加
  - [x] `src/lib/security.ts` — state型を `provider` + `external_org_id` に更新
  - [x] logi-proto npm パッケージ publish 済み（GitHub Actions: `sso_settings_pb` export 追加）
  - [x] auth-worker デプロイ済み: `auth.mtamaramu.com`
- [x] Phase 5: cf-grpc-proxy PUBLIC_PATHS 追加
  - [x] `/logi.auth.AuthService/ResolveSsoProvider`
  - [x] `/logi.auth.AuthService/LoginWithSsoProvider`
  - [x] cf-grpc-proxy デプロイ済み

## 未完了
- [ ] **Phase 6: フロントエンド管理者設定画面** — `/home/yhonda/js/nuxt-pwa-carins/`
  - [ ] `composables/useSsoSettings.ts` — `SsoSettingsService` の gRPC クライアント（GetConfig, UpsertConfig, DeleteConfig, ListConfigs）
  - [ ] `components/admin/SsoSettings.vue` — 管理者向け SSO 設定画面
    - プロバイダ選択（lineworks）
    - client_id / client_secret / external_org_id 入力
    - 有効/無効切り替え
    - 既存設定の一覧表示
  - [ ] ルーティング追加（管理者メニューに SSO 設定リンク）
- [ ] **E2E テスト** — LINE WORKS の実 OAuth 設定を DB に登録して、ログインフロー全体を検証
  - `sso_provider_configs` に test record を INSERT
  - `https://auth.mtamaramu.com/login` → LINE WORKS アドレス入力 → 認証 → JWT 取得

## 次のアクション
- [ ] nuxt-pwa-carins の既存 admin ページの構造を調査 — `ls /home/yhonda/js/nuxt-pwa-carins/pages/admin/`
- [ ] `SsoSettingsService` の proto 定義を確認 — `packages/logi-proto/proto/sso_settings.proto`
- [ ] composable + コンポーネント実装
- [ ] テスト用 SSO config を DB に登録してフロー検証:
  ```sql
  INSERT INTO sso_provider_configs (organization_id, provider, client_id, client_secret_encrypted, external_org_id, enabled)
  VALUES ('00000000-0000-0000-0000-000000000001', 'lineworks', '<client_id>', '<encrypted_secret>', 'ohishi', true);
  ```

## 注意事項
- `client_secret_encrypted` は AES-256-GCM で暗号化が必要（`src/services/lineworks_auth.rs` の `encrypt_secret` 使用、鍵は JWT_SECRET の SHA-256）
- LINE WORKS Developer Console で OAuth アプリ作成が必要（Redirect URI: `https://auth.mtamaramu.com/oauth/lineworks/callback`）
- `sso_provider_configs` テーブルは RLS ENABLE だが FORCE なし（認証前クエリ用）
- auth-worker の `package.json` は `"@yhonda-ohishi-pub-dev/logi-proto": "latest"` に戻してある（`file:` プロトコルだと wrangler バンドル時に `@bufbuild/protobuf/codegenv2` 解決不能）
- Cloud SQL Proxy: `./start-proxy.sh` で起動（DB操作時に必要）

## 変更ファイル一覧（今回のセッション）

| リポジトリ | ファイル | 変更内容 |
|-----------|---------|---------|
| rust-logi | `.gitignore` | `/services/` に修正（`src/services/` 誤マッチ防止）|
| rust-logi | `packages/logi-proto/src/index.ts` | `sso_settings_pb` export 追加 |
| auth-worker | `src/handlers/lineworks-redirect.ts` | 新規: LINE WORKS OAuth リダイレクト |
| auth-worker | `src/handlers/lineworks-callback.ts` | 新規: LINE WORKS OAuth コールバック |
| auth-worker | `src/index.ts` | LINE WORKS ルート追加 |
| auth-worker | `src/handlers/login-page.ts` | lineworksRedirectUrl パラメータ追加 |
| auth-worker | `src/lib/html.ts` | LINE WORKS アドレス入力フィールド + CSS |
| auth-worker | `src/lib/security.ts` | state型を provider + external_org_id に更新 |
| auth-worker | `package.json` | logi-proto を latest に変更 |
| cf-grpc-proxy | `src/index.ts` | PUBLIC_PATHS に SSO パス2件追加 |
