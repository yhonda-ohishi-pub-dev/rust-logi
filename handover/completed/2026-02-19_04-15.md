# 引き継ぎ: 組織管理・認証システム — デプロイ前検証

## ステータス: 実装完了 / 検証・デプロイ未着手

前回引き継ぎ: `handover/completed/2026-02-19_03-59.md`
計画書: `.claude/plans/vast-yawning-toast.md`

---

## 完了

- [x] AuthService (SignUpWithGoogle, LoginWithGoogle, Login, ValidateToken)
- [x] OrganizationService (ListMyOrganizations, UpdateOrganization)
- [x] MemberService (InviteUser, AcceptInvitation, ListMembers, RemoveMember, PromoteToAdmin, DemoteFromAdmin, TransferAdmin)
- [x] Auth Middleware (Tower Layer JWT認証 + AuthenticatedUser注入)
- [x] Google IDトークン検証 (`src/google_auth.rs` JWKS検証)
- [x] Proto定義 (auth.proto, organization.proto, member.proto)
- [x] モデル (app_user.rs, organization_model.rs, password_credential.rs)
- [x] マイグレーション (00022_create_password_credentials.sql)
- [x] main.rs統合 + `cargo build` 成功 (警告0)
- [x] cf-grpc-proxy CORS更新 (`Authorization`, `X-Organization-Id` ヘッダー追加)

## 未完了

- [ ] **マイグレーション実行** — `./start-proxy.sh` → `sqlx migrate run --database-url "postgres://postgres:kikuraku@127.0.0.1:5432/rust_logi_test"`
- [ ] **`.env` に環境変数追加** — `JWT_SECRET` (必須), `GOOGLE_CLIENT_ID` (Google Cloud Console → Credentials)
- [ ] **サーバー起動テスト** — `./start-proxy.sh` → `./start.sh`
- [ ] **grpcurl検証** — 各RPCの動作確認
  - [ ] Login (username/password)
  - [ ] SignUpWithGoogle / LoginWithGoogle
  - [ ] InviteUser → AcceptInvitation → Login フロー
  - [ ] PromoteToAdmin / DemoteFromAdmin / TransferAdmin
  - [ ] JWT認証なし → UNAUTHENTICATED 確認
  - [ ] JWT付き → 正常動作確認
- [ ] **cf-grpc-proxy デプロイ** — 元リポジトリで `wrangler deploy`
- [ ] **Cloud Run デプロイ** — `./deploy.sh`
- [ ] **gitコミット** — 14ファイル変更 + 10ファイル新規 (未コミット)

## 次のアクション

- [ ] Cloud SQL Proxy起動 — `./start-proxy.sh`
- [ ] マイグレーション実行 — `sqlx migrate run --database-url "postgres://postgres:kikuraku@127.0.0.1:5432/rust_logi_test"`
- [ ] `.env`に`JWT_SECRET`と`GOOGLE_CLIENT_ID`を追加
- [ ] サーバー起動 — `./start.sh`
- [ ] grpcurlでテスト — `grpcurl -plaintext -d '{"username":"test", "password":"pass"}' localhost:50051 logi.auth.AuthService/Login`

## 注意事項

- 全コード変更は未コミット状態（`git status` で14 modified + 10 untracked）
- `password_credentials` テーブルは RLS有効 / NO FORCE → ログイン時にorg contextなしでクエリ可能
- Auth Middleware PUBLIC_PATHS: Login, SignUpWithGoogle, LoginWithGoogle, ValidateToken, AcceptInvitation, Health, Reflection
- `get_organization_from_request` は AuthenticatedUser extensions を優先、fallback で x-organization-id ヘッダー
- 全ての新規クエリは `sqlx::query_as` (非マクロ版) → DB接続なしでコンパイル可能

## 新規ファイル

| ファイル | 内容 |
|----------|------|
| `migrations/00022_create_password_credentials.sql` | パスワード認証テーブル |
| `packages/logi-proto/proto/organization.proto` | 組織管理Proto |
| `packages/logi-proto/proto/member.proto` | メンバー管理Proto |
| `src/google_auth.rs` | Google IDトークン検証 + JWKSキャッシュ |
| `src/middleware/mod.rs` + `auth.rs` | JWT認証ミドルウェア (Tower Layer) |
| `src/services/organization_service.rs` | 組織管理サービス |
| `src/services/member_service.rs` | メンバー管理サービス |
| `src/models/app_user.rs` | ユーザーモデル |
| `src/models/organization_model.rs` | 組織モデル |
| `src/models/password_credential.rs` | パスワード認証モデル |

## 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `packages/logi-proto/proto/auth.proto` | SignUpWithGoogle追加, LoginWithGoogle変更 |
| `build.rs` | 新proto追加 |
| `src/proto/mod.rs` | organization, member モジュール追加 |
| `src/services/mod.rs` | 新サービス追加 |
| `src/services/auth_service.rs` | Google ID検証, SignUp, Login実装 (+247行) |
| `src/db/organization.rs` | AuthenticatedUser対応 |
| `src/config.rs` | jwt_secret, google_client_id 追加 |
| `src/main.rs` | AuthLayer + 新サービス登録 |
| `src/lib.rs` | middleware, google_auth モジュール追加 |
| `Cargo.toml` | http-body-util, bytes 追加 |
| `.gitignore` | cf-grpc-proxy_ref 追加 |
