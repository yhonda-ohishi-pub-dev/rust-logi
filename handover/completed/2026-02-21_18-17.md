# 引き継ぎ: LINE WORKS Bot リッチメニュー管理画面

## ステータス: API仕様調査完了・実装プラン承認済み・実装未着手

---

## 完了
- [x] LINE WORKS Rich Menu API v2 仕様調査（Playwright で公式ドキュメントから全API仕様を取得）
- [x] 既存コードベース調査（lineworks-bot-rust, auth-worker の構造・パターン把握）
- [x] 実装プラン作成・承認 — `/home/yhonda/.claude/plans/hazy-launching-dongarra.md`
- [x] API仕様ドキュメント作成 — `docs/lineworks-rich-menu-api.md`

## 未完了
- [ ] **Step 1: LINE WORKS Bot API クライアント** — `auth-worker/src/lib/lineworks-bot-api.ts` 新規作成
  - JWT生成（Web Crypto API で RS256 署名）
  - OAuth2 トークン取得・キャッシュ
  - Rich Menu API ラッパー関数群
- [ ] **Step 2: API エンドポイント** — `auth-worker/src/handlers/api-rich-menu.ts` 新規作成
  - `/api/richmenu/list`, `/api/richmenu/create`, `/api/richmenu/delete`
  - `/api/richmenu/image`, `/api/richmenu/default/set`, `/api/richmenu/default/get`, `/api/richmenu/default/delete`
- [ ] **Step 3: 管理画面 HTML** — `auth-worker/src/lib/admin-rich-menu-html.ts` 新規作成
  - admin-sso と同じ SPA パターン（インライン CSS + JS）
  - メニュー一覧、作成フォーム、画像アップロード、デフォルト設定
- [ ] **Step 4: ページハンドラ** — `auth-worker/src/handlers/admin-rich-menu.ts` 新規作成
  - cookie チェック → ページ配信（admin-sso パターン踏襲）
- [ ] **Step 5: ルーティング追加 + Env 型拡張** — `auth-worker/src/index.ts` 変更
  - GET `/admin/rich-menu`, `/admin/rich-menu/callback`
  - POST 7つの API エンドポイント
  - Env に `LW_BOT_CLIENT_ID`, `LW_BOT_CLIENT_SECRET`, `LW_BOT_SERVICE_ACCOUNT`, `LW_BOT_PRIVATE_KEY`, `LW_BOT_ID` 追加
- [ ] **Step 6: wrangler.toml** — secrets コメント追加
- [ ] **Secrets 設定** — `wrangler secret put` で5つの環境変数を設定（値は `lineworks-bot-rust/.env` と同じ）
- [ ] **デプロイ・動作確認**

## 次のアクション
- [ ] プランファイル読み込み — `/home/yhonda/.claude/plans/hazy-launching-dongarra.md`
- [ ] API仕様参照 — `docs/lineworks-rich-menu-api.md`
- [ ] Step 1 から実装開始 — `auth-worker/src/lib/lineworks-bot-api.ts`
- [ ] 参考コード: JWT生成 — `lineworks-bot-rust/src/services/jwt.rs`
- [ ] 参考コード: OAuth認証 — `lineworks-bot-rust/src/services/auth.rs`
- [ ] 参考コード: admin-sso パターン — `auth-worker/src/handlers/admin-sso.ts`, `auth-worker/src/lib/admin-html.ts`, `auth-worker/src/handlers/api-sso.ts`

## 注意事項
- **auth-worker のみで完結**（rust-logi 変更不要）
- auth-worker は Cloudflare Workers なので Node.js crypto は使えない → **Web Crypto API** で JWT 生成
- 画像アップロードは3ステップ: (1) POST /attachments → fileId + uploadUrl (2) PUT uploadUrl にバイナリ (3) POST /richmenus/{id}/image に fileId
- 画像要件: JPEG/PNG, 2500x843 or 2500x1686, max 1MB
- リッチメニューの用途: アプリリンク（carins, dtako logs へのURLボタン）
- Bot credentials は lineworks-bot-rust の .env にある: CLIENT_ID, CLIENT_SECRET, SERVICE_ACCOUNT, PRIVATE_KEY, BOT_ID
