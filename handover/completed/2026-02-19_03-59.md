# 引き継ぎ: 組織管理・認証システム実装

## ステータス: Phase 1-7 完了 / Phase 8 (検証) 未着手

計画書: `.claude/plans/vast-yawning-toast.md`

---

## 完了

- [x] Phase 1: DB マイグレーション作成 + Proto定義 + ビルド設定
- [x] Phase 2: モデル + Google認証 (`google_auth.rs` JWKS検証)
- [x] Phase 3: AuthService (SignUpWithGoogle, LoginWithGoogle, Login, ValidateToken)
- [x] Phase 4: OrganizationService (ListMyOrganizations, UpdateOrganization)
- [x] Phase 5: MemberService (InviteUser, AcceptInvitation, ListMembers, RemoveMember, PromoteToAdmin, DemoteFromAdmin, TransferAdmin)
- [x] Phase 6: Auth Middleware (Tower Layer JWT認証 + AuthenticatedUser注入)
- [x] Phase 7: main.rs統合 + `cargo build` 成功 (警告0)
- [x] cf-grpc-proxy CORS更新 (`Authorization`, `X-Organization-Id` ヘッダー追加)

## 未完了

- [ ] **マイグレーション実行** (Phase 1.2 / 8.1) — `./start-proxy.sh` → `sqlx migrate run --database-url "postgres://postgres:kikuraku@127.0.0.1:5432/rust_logi_test"`
- [ ] **`.env` に `GOOGLE_CLIENT_ID` 追加** (Phase 2.7) — Google Cloud Console → APIs & Services → Credentials から取得
- [ ] **サーバー起動テスト** (Phase 7.4) — `./start-proxy.sh` → `./start.sh`
- [ ] **grpcurl検証** (Phase 8.2-8.7) — SignUpWithGoogle, LoginWithGoogle, InviteUser→AcceptInvitation→Login, PromoteToAdmin/DemoteFromAdmin/TransferAdmin, JWT認証なし→UNAUTHENTICATED確認, JWT付き→正常動作確認
- [ ] **cf-grpc-proxy デプロイ** — 元リポジトリで `wrangler deploy`
- [ ] **Cloud Run デプロイ** — `./deploy.sh`

## 次のアクション

- [ ] Cloud SQL Proxy起動 — `./start-proxy.sh`
- [ ] マイグレーション実行 — `sqlx migrate run --database-url "postgres://postgres:kikuraku@127.0.0.1:5432/rust_logi_test"`
- [ ] `.env`に`GOOGLE_CLIENT_ID`を追加してサーバー起動 — `./start.sh`
- [ ] grpcurlでテスト — `grpcurl -plaintext -d '{"organization_id":"...", "username":"test", "password":"pass"}' localhost:50051 logi.auth.AuthService/Login`

## 注意事項

- 全ての新規クエリは `sqlx::query_as` (非マクロ版) を使用 → DB接続なしでコンパイル可能
- `password_credentials` テーブルは RLS有効 / NO FORCE → ログイン時にorg contextなしでクエリ可能
- Auth Middleware の PUBLIC_PATHS: Login, SignUpWithGoogle, LoginWithGoogle, ValidateToken, AcceptInvitation, Health, Reflection
- `get_organization_from_request` は AuthenticatedUser extensions を優先、fallback で x-organization-id ヘッダー

## 新規作成ファイル

| ファイル | 内容 |
|----------|------|
| `migrations/00022_create_password_credentials.sql` | パスワード認証テーブル |
| `packages/logi-proto/proto/organization.proto` | 組織管理Proto |
| `packages/logi-proto/proto/member.proto` | メンバー管理Proto |
| `src/google_auth.rs` | Google IDトークン検証 + JWKSキャッシュ |
| `src/middleware/mod.rs` + `auth.rs` | JWT認証ミドルウェア (Tower Layer) |
| `src/services/organization_service.rs` | 組織管理サービス |
| `src/services/member_service.rs` | メンバー管理サービス |
| `src/models/app_user.rs` | ユーザーモデル |
| `src/models/organization_model.rs` | 組織モデル |
| `src/models/password_credential.rs` | パスワード認証モデル |

## 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `packages/logi-proto/proto/auth.proto` | SignUpWithGoogle追加, LoginWithGoogle変更 |
| `build.rs` | 新proto追加 |
| `src/proto/mod.rs` | organization, member モジュール追加 |
| `src/services/mod.rs` | 新サービス追加 |
| `src/services/auth_service.rs` | Google ID検証, SignUp, Login実装 |
| `src/db/organization.rs` | AuthenticatedUser対応 |
| `src/config.rs` | google_client_id追加 |
| `src/main.rs` | AuthLayer + 新サービス登録 |
| `src/lib.rs` | middleware, google_auth追加 |
| `Cargo.toml` | http-body-util, bytes 追加 |
| `.gitignore` | cf-grpc-proxy_ref 追加 |
| `cf-grpc-proxy_ref/src/index.ts` | CORS ヘッダー追加 |
