# 引き継ぎ: WOFF SDK マルチテナント — リロードループバグ修正

## ステータス: 全完了・デプロイ済み

---

## 完了
- [x] DB マイグレーション `00026_add_woff_id` 適用済み
- [x] rust-logi デプロイ済み（revision `rust-logi-00101-lv7`）
- [x] logi-proto v0.1.33 publish 済み
- [x] auth-worker デプロイ済み — `/auth/woff`, `/auth/woff-config` エンドポイント
- [x] auth-worker SSO管理画面 — WOFF ID入力欄 + 動的エンドポイントURL表示 + コピーボタン (commit `64828b3`)
- [x] auth-worker: LINE WORKS in-app browser 対策 — callback で JWT を親ドメイン cookie にセット (commit `020ff26`)
- [x] nuxt-pwa-carins デプロイ済み + コミット済み (commit `4b556b7`)
- [x] WOFF SDK CDN をグローバルから除去、`auth.client.ts` で動的ロードに変更
- [x] `server/middleware/auth.ts` に `?woff` SSR パス・スルー追加（WOFF 認証をクライアントに委任）
- [x] `plugins/auth.client.ts` に cookie からの認証復旧を追加（LINE WORKS ブラウザの hash fragment 上書き対策）
- [x] WOFF auth の `domainId` を `profile.domainId`（数値）から `domain`（文字列）に修正
- [x] E2E 動作検証完了 — LINE WORKS アプリ内で `WOFF: AUTH SUCCESS` 確認

## 解決した問題

### 1. リロードループ（`?lw=ohishiunyusouko&woff`）
**原因**: SSR middleware が `?woff` リクエストも OAuth リダイレクトに送っていた。`?woff` パラメータが OAuth redirect_uri に含まれないため消失し、WOFF フローが実行されなかった。
**修正**: SSR middleware で `?woff` を検出したらリダイレクトせずクライアントに処理を委任。

### 2. LINE WORKS in-app browser が hash fragment を上書き
**原因**: LINE WORKS アプリ内ブラウザが auth-worker の `#token=...` を独自の `#access_token=...` に上書きする。`consumeFragment()` が JWT を取得できず未認証ループ。
**修正**: auth-worker の lineworks-callback で JWT を親ドメイン (`.mtamaramu.com`) の cookie にもセット。クライアントプラグインに cookie からの認証復旧ステップ（Step 2.5）を追加。

### 3. WOFF auth 401 エラー（domainId 不一致）
**原因**: `woff.getProfile().domainId` が数値 (`10133534`) を返すが、DB の `external_org_id` は文字列 (`ohishiunyusouko`)。
**修正**: `domainId: profile.domainId` → `domainId: domain`（URL/localStorage のドメイン名）に変更。

## 変更ファイル一覧

### auth-worker
- `src/handlers/lineworks-callback.ts` — JWT を Set-Cookie でも送信（親ドメイン共有）
- `src/handlers/api-sso.ts` — woffId フィールド追加
- `src/lib/admin-html.ts` — WOFF ID 入力欄 + 動的エンドポイント URL

### nuxt-pwa-carins
- `server/middleware/auth.ts` — `?woff` SSR パス・スルー + `lw_domain` cookie 設定
- `plugins/auth.client.ts` — cookie 復旧 + WOFF domainId 修正 + 不要な `woff.getProfile()` 削除

## 注意事項
- `external_org_id` は `ohishiunyusouko`（`ohishi` ではない）
- nuxt-pwa-carins は `git push` で自動デプロイ**されない** → `npm run deploy` が必要
- WOFF App の LINE WORKS Developer Console 登録は手動作業（ユーザーが実施済み）
- WOFF ID は SSO管理画面 (`https://auth.mtamaramu.com/admin/sso`) から設定可能
