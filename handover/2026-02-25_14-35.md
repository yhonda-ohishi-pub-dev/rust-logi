# Handover: GrpcWebTrailerFix ミドルウェア + CF Containers デプロイ

**日時**: 2026-02-25 14:35
**計画書**: `/home/yhonda/.claude/plans/humble-meandering-kernighan.md`
**前回 handover**: `handover/2026-02-25_13-45.md`

## 完了タスク

- [x] `GrpcWebTrailerFixLayer` Tower ミドルウェア実装 (`src/middleware/grpc_web_fix.rs`)
- [x] `src/middleware/mod.rs` にモジュール登録
- [x] `src/main.rs` にレイヤー追加（GrpcWebLayer の外側）
- [x] ローカルビルド・テスト成功
- [x] CF Containers デプロイ（3回: ミドルウェア初版 → 空データフレーム追加版 → 環境変数追加版）
- [x] cf-grpc-proxy を Container 向けに切り替えデプロイ済み
- [x] `GOOGLE_CLIENT_ID` 等の不足環境変数を `cf-container/src/index.ts` に追加
- [x] DO ID を `main` → `main-v2` に変更してコンテナ強制再起動

## 現在の状態

### ミドルウェアの動作

gRPC-Web の「trailers-only」レスポンス（空ボディ + grpc-status ヘッダー）を検出し、ボディ内に空データフレーム + トレーラーフレームを書き込む。これにより `container.fetch()` のクラッシュを回避。

```
変換前: HTTP 200, content-length: 0, grpc-status: N (ヘッダー)
変換後: HTTP 200, content-length: N, body: [0x00 empty data frame][0x80 trailer frame]
```

### テスト結果

| テスト | curl gRPC-Web (HTTP/1.1) | grpcurl native (HTTP/2) |
|--------|-------------------------|------------------------|
| Health/Check | OK — SERVING | OK — SERVING |
| ListFiles | 未テスト | OK — データ返却 |
| Login エラー | OK — trailer frame にエラー情報 | NG — `payload format 128`（CF edge 制限） |
| LoginWithGoogle | OK — `Invalid token`（GOOGLE_CLIENT_ID 認識済み） | 未テスト |

### 未解決の問題

**`[invalid_argument] protocol error: incomplete envelope`**

ブラウザ（connect-web クライアント）から `LoginWithGoogle` を呼んだ際に発生。原因の可能性:

1. **空データフレーム（5 バイト）の影響**: connect-web が空データフレーム (`\x00\x00\x00\x00\x00`) を空メッセージとしてデコードしようとして失敗している可能性。connect-web は unary RPC で1つのメッセージを期待するが、空データフレーム + トレーラーフレームの2フレーム構成が問題かもしれない

2. **修正案 A**: 空データフレームを除去し、トレーラーフレームのみにする（最初のバージョンに戻す）。container.fetch() は Content-Length > 0 なら通る可能性がある

3. **修正案 B**: connect-web のエラーハンドリングを調査。`@connectrpc/connect-web` のソースで `incomplete envelope` エラーがどこで発生するか確認

4. **修正案 C**: cf-grpc-proxy（TypeScript Worker）側でレスポンスを変換。Container Worker ではなく cf-grpc-proxy のレスポンスハンドリングでトレーラーフレームを処理

## デプロイ済みリソース

| リソース | URL/状態 |
|---------|---------|
| CF Container Worker | `api-container.mtamaramu.com` (DO ID: `main-v2`) |
| cf-grpc-proxy | `sync.mtamaramu.com` → `api-container.mtamaramu.com` にプロキシ |
| Cloud Run | `rust-logi-566bls5vfq-an.a.run.app` — 稼働中（フォールバック可） |

## ファイル変更

| ファイル | 状態 |
|---------|------|
| `src/middleware/grpc_web_fix.rs` | 新規作成（GrpcWebTrailerFixLayer） |
| `src/middleware/mod.rs` | `pub mod grpc_web_fix;` 追加 |
| `src/main.rs:8,181` | import + layer 追加 |
| `cf-container/src/index.ts` | 環境変数追加 + DO ID `main-v2` |
| `workers/cf-grpc-proxy/wrangler.toml` | `RUST_LOGI_PROXY_URL` → Container |
| `workers/cf-grpc-proxy/src/index.ts` | IAM トークン条件付き |

## ロールバック手順

cf-grpc-proxy を Cloud Run に戻す場合:
```bash
cd /home/yhonda/js/nuxt_dtako_logs/cf-grpc-proxy
# wrangler.toml の RUST_LOGI_PROXY_URL を戻す
sed -i 's|api-container.mtamaramu.com|cloudrun-backend.mtamaramu.com|' wrangler.toml
npx wrangler deploy
```

## 次のセッションでやること

1. **`incomplete envelope` エラーの調査・修正**
   - connect-web がどのフレームで失敗しているか特定
   - 空データフレームが原因なら除去する修正を検討
   - または cf-grpc-proxy 側でのレスポンス変換を検討

2. **全 RPC のブラウザ E2E テスト**
   - ログイン（Google / LINE WORKS）
   - 車検証一覧・PDF表示
   - ファイルアップロード・ダウンロード
   - Items CRUD

3. **Cloud Run フォールバック判断**
   - 全 RPC が Container で動作確認できたら Cloud Run を停止
