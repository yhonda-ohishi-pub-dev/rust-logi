# 引き継ぎ: LINE WORKS SSO OAuth 実装（汎用SSO設計リファクタ）

## ステータス: Phase 3（Rust実装）完了・コンパイル成功 / Phase 4-6 未着手 / DB マイグレーション未実行

---

## 完了
- [x] Phase 1: DB マイグレーション SQL 作成（`migrations/00024`, `00025`）— 未実行
- [x] Phase 2: Proto 定義（`auth.proto` に ResolveSsoProvider/LoginWithSsoProvider、`sso_settings.proto` 新規作成）
- [x] Phase 3: Rust 実装 — **コンパイル復旧完了**
  - [x] `Cargo.toml` — `urlencoding = "2"` 依存追加
  - [x] `src/services/lineworks_auth.rs` — 重複 OAuth コード削除（encrypt/decrypt のみ残す）
  - [x] `src/services/sso_settings_service.rs` — 新規作成（旧 lineworks_settings_service.rs ベース）
  - [x] `src/services/mod.rs` — `sso_providers` + `sso_settings_service` モジュール追加
  - [x] `src/services/auth_service.rs` — `resolve_sso_provider` + `login_with_sso_provider` 実装
  - [x] `src/main.rs` — `SsoSettingsServiceServer` / `SsoSettingsServiceImpl` に更新
  - [x] `src/middleware/auth.rs` — PUBLIC_PATHS を ResolveSsoProvider/LoginWithSsoProvider に更新
  - [x] 旧 `lineworks_settings_service.rs` 削除
  - [x] `cargo build --release` 成功
  - [x] `cargo test --release` 全9テスト pass

## 未完了
- [ ] **DB マイグレーション実行** — `sso_provider_configs` テーブル + roles/permissions テーブル作成
- [ ] **Cloud Run デプロイ** — SSO 対応バイナリを反映
- [ ] **Phase 4: auth-worker 変更** — `/home/yhonda/js/auth-worker/`
  - LINE WORKS リダイレクト/コールバック ハンドラー追加
  - ログインページに LINE WORKS アドレス入力フィールド追加
  - logi-proto npm パッケージ更新が必要（新 RPC 追加済み）
- [ ] **Phase 5: cf-grpc-proxy PUBLIC_PATHS 追加** — `/home/yhonda/js/nuxt_dtako_logs/cf-grpc-proxy/src/index.ts`
  - `/logi.auth.AuthService/ResolveSsoProvider`
  - `/logi.auth.AuthService/LoginWithSsoProvider`
- [ ] **Phase 6: フロントエンド管理画面** — `/home/yhonda/js/nuxt-pwa-carins/`
  - SSO 設定画面（composables/useLineworksSettings.ts → SsoSettingsService gRPC クライアント）

## 次のアクション
- [ ] マイグレーション実行 — `source .env && sqlx migrate run`
- [ ] デプロイ — `./deploy.sh`
- [ ] logi-proto npm パッケージ publish — `cd packages/logi-proto && git push`（pre-push フックで自動）
- [ ] auth-worker 実装 — Phase 4 の詳細は `handover/2026-02-21_02-52.md` の Phase 4 セクション参照

## 注意事項
- マイグレーション `00024` の `sso_provider_configs` テーブルは RLS ENABLE だが **FORCE なし**（認証前クエリ用）
- `resolve_sso_provider` の `authorize_url` フィールドはプロバイダの authorize エンドポイント URL のみ返す（redirect_uri/state は auth-worker 側で付与）
- `sso_providers::exchange_code()` は access_token（String）のみ返す（旧 LineworksTokenResponse と異なる）
- 旧 handover `handover/2026-02-21_02-52.md` の Phase 3 コンパイルエラー 7 箇所はすべて解消済み
- git status: 多数の未コミット変更あり（コミットは未実施）

## 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `Cargo.toml` | `urlencoding = "2"` 追加 |
| `src/services/lineworks_auth.rs` | 重複コード削除（encrypt/decrypt のみ残す）|
| `src/services/sso_settings_service.rs` | 新規作成（汎用 SSO 設定サービス）|
| `src/services/mod.rs` | `sso_providers` + `sso_settings_service` 追加 |
| `src/services/auth_service.rs` | 旧メソッド削除 → 新 SSO メソッド実装 |
| `src/main.rs` | SsoSettings サービス配線 |
| `src/middleware/auth.rs` | PUBLIC_PATHS 更新 |
| `src/services/lineworks_settings_service.rs` | 削除 |
