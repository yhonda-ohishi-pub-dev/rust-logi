# Handover: Items 詳細表示 + 所有権変更（組織⇔個人）

## 完了タスク

### 1. アイテム詳細表示モーダル
- 行クリック → 読み取り専用の詳細表示モーダルを表示するように変更
- 変更前: 行クリック → フォルダナビゲーション（リーフアイテムで空表示）
- 変更後: 行クリック → 詳細モーダル、矢印ボタン → フォルダナビゲーション
- **デプロイ済み**: nuxt-items (items.mtamaramu.com)

変更ファイル:
- `nuxt-items/components/items/ItemDetail.vue` — 新規（詳細表示コンポーネント）
- `nuxt-items/components/items/ItemList.vue` — `onRowClick` を `emit('select')` に変更
- `nuxt-items/pages/index.vue` — 詳細モーダル状態・テンプレート・ハンドラ追加

### 2. ChangeItemOwnership RPC（バックエンド）
- `ChangeItemOwnership` RPC を追加（再帰CTE で子孫も一括変更）
- **デプロイ済み**: rust-logi (Cloud Run revision: `rust-logi-00113-hpm`)

変更ファイル:
- `packages/logi-proto/proto/items.proto` — `ChangeItemOwnership` RPC + `ChangeItemOwnershipReq` 追加
- `src/services/items_service.rs` — `change_item_ownership` 実装

### 3. フロントエンド所有権変更UI
- ItemDetail.vue に「個人に移動」/「組織に移動」ボタン追加
- **デプロイ済み**: nuxt-items (items.mtamaramu.com)

変更ファイル:
- `nuxt-items/composables/useItems.ts` — `changeOwnership()` 関数追加
- `nuxt-items/components/items/ItemDetail.vue` — 移動ボタン + `change-ownership` emit
- `nuxt-items/pages/index.vue` — `onChangeOwnership` ハンドラ

## 未解決: 「個人に移動」ボタンが動作しない

### 症状
詳細モーダルの「個人に移動」ボタンを押しても、アイテムが個人タブに移動しない。

### 調査ポイント

1. **Cloud Run ログ確認**: RPC が到達しているか、エラーが出ているか
   ```bash
   gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="rust-logi" AND textPayload:"change_item_ownership"' --limit=20 --format="table(timestamp, textPayload)"
   ```

2. **RLS ポリシーの問題の可能性**:
   - `setup_dual_rls` は org + user 両方のコンテキストを設定
   - RLS の WITH CHECK が org→personal 変更を許可するか要確認
   - items_org_policy の WITH CHECK: `owner_type = 'org' AND organization_id = get_current_organization_uuid()`
   - items_personal_policy の WITH CHECK: `owner_type = 'personal' AND user_id = get_current_user_uuid()`
   - PERMISSIVE ポリシーなので OR 結合 → 理論上は通るはず
   - **ただし**: 再帰CTEの SELECT がRLSでフィルタされる可能性あり

3. **再帰CTEとRLSの相互作用**:
   ```sql
   WITH RECURSIVE descendants AS (
       SELECT id FROM items WHERE id = $1::uuid  -- ← RLS がここに適用される
       UNION ALL
       SELECT i.id FROM items i JOIN descendants d ON i.parent_id = d.id
   )
   UPDATE items SET ... WHERE id IN (SELECT id FROM descendants)
   ```
   - CTE内の `SELECT id FROM items` にRLSが適用される
   - org アイテムなら items_org_policy で見える → OK
   - しかし UPDATE 後の WITH CHECK で new_owner_type='personal' を検証する際、
     items_personal_policy の WITH CHECK は `owner_type = 'personal' AND user_id = get_current_user_uuid()` → これは通る
   - items_org_policy の WITH CHECK は `owner_type = 'org' AND ...` → これは失敗するが、PERMISSIVE なので片方通ればOK

4. **フロントエンド側の問題の可能性**:
   - `$grpc.items.changeItemOwnership` が正しくRPCを呼んでいるか
   - gRPC-Web プロキシ (cf-grpc-proxy) が新RPCをルーティングしているか
   - ブラウザのネットワークタブでリクエスト/レスポンスを確認

5. **gRPC-Web プロキシの問題**:
   - `cf-grpc-proxy` が Connect RPC の新メソッドを正しく転送するか確認
   - Connect RPC は URL パスにメソッド名を含む: `/logi.items.ItemsService/ChangeItemOwnership`
   - プロキシがワイルドカードルーティングなら問題なし

### デバッグ手順（推奨）

1. ブラウザの開発者ツール → Network タブで `ChangeItemOwnership` リクエストを確認
2. レスポンスのステータスコードとボディを確認
3. Cloud Run のログで該当リクエストを検索
4. 必要に応じて `items_service.rs` にログ出力を追加してデバッグ

### 関連ファイル
- Plan: `/home/yhonda/.claude/plans/jiggly-napping-journal.md`
- Proto: `packages/logi-proto/proto/items.proto`
- Rust: `src/services/items_service.rs` (行399-450)
- RLS: `migrations/00029_create_items.sql` (items_org_policy, items_personal_policy)
- Frontend: `nuxt-items/composables/useItems.ts` (行104-108)
- Frontend: `nuxt-items/components/items/ItemDetail.vue`
- Frontend: `nuxt-items/pages/index.vue` (行316-319)

## その他の未コミット変更

- `src/models/item.rs` — `url` フィールド追加
- `src/services/items_service.rs` — `url` フィールド対応 + `change_item_ownership`
- `packages/logi-proto/proto/items.proto` — `url` フィールド + `ChangeItemOwnership` RPC
- `migrations/00030_add_url_to_items.sql` — `url` カラム追加（DB適用済み）
