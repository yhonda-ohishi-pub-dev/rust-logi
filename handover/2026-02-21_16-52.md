# 引き継ぎ: WOFF トップページ + cross-subdomain cookie 共有

## ステータス: 全コード完了・全デプロイ済み / LINE WORKS Developer Console 手動設定のみ残り

---

## 完了
- [x] auth-worker `/top` ランディングページ作成（WOFF SDK 認証 + アプリメニュー）
  - `src/lib/top-html.ts` — HTML テンプレート（WOFF SDK 動的ロード + 認証フロー + ナビゲーション）
  - `src/handlers/top-page.ts` — `GET /top` ハンドラー（`ALLOWED_REDIRECT_ORIGINS` からアプリ一覧生成）
  - `src/index.ts` — `/top` ルート追加
- [x] admin-html WOFF URL を `/top` に変更
  - `src/lib/admin-html.ts` — `renderConfigs()` と `updateWoffEndpointHint()` で WOFF URL を `auth.mtamaramu.com/top?lw=...&woff` に
- [x] auth-client `recoverFromCookie()` 追加（cookie からの JWT 復旧を共通化）
  - `packages/auth-client/src/useAuth.ts` — `recoverFromCookie()` 関数追加、return に含める
- [x] auth-client cookie Domain を `.mtamaramu.com` に修正（cross-subdomain 共有）
  - `writeStorage()`, `clearStorage()`, `saveLwDomain()`, `clearLwDomain()` に `Domain=${getParentDomain()}` 追加
  - `getParentDomain()` ヘルパー関数追加（hostname から親ドメインを動的取得）
- [x] nuxt-pwa-carins: インライン cookie 復旧を `recoverFromCookie()` に置換
  - `plugins/auth.client.ts` — 127-150行のインラインロジックを1行に
- [x] nuxt-dtako-logs: `recoverFromCookie()` による cookie 復旧追加
  - `plugins/auth.client.ts` — `loadFromStorage()` 後に `recoverFromCookie()` 呼び出し追加
- [x] auth-worker デプロイ (`ba4347a`) — `wrangler deploy` 済み
- [x] auth-client v0.1.x GitHub Packages publish 済み（GitHub Actions 自動）
- [x] nuxt-pwa-carins デプロイ (`cb3000e`) — `npm run deploy` 済み
- [x] nuxt-dtako-logs デプロイ (`c444f97`) — `npm run deploy` 済み
- [x] `https://auth.mtamaramu.com/top` 動作確認（HTTP 200、アプリ一覧正常表示）

## 未完了
- [ ] **LINE WORKS Developer Console で WOFF エンドポイント URL 変更**（手動）
  - 旧: `https://nuxt-pwa-carins.mtamaramu.com/?lw=ohishi&woff`
  - 新: `https://auth.mtamaramu.com/top?lw=ohishi&woff`
- [ ] LINE WORKS アプリ内からの E2E テスト（WOFF 認証 → トップページ → 各アプリ遷移）

## 次のアクション
- [ ] LINE WORKS Developer Console にログインし、WOFF アプリのエンドポイント URL を更新
- [ ] LINE WORKS アプリ内で WOFF アプリを開いて認証 → メニュー表示 → carins/dtako-logs 遷移を確認
- [ ] SSO 管理画面 (`https://auth.mtamaramu.com/admin/sso`) で WOFF URL が `/top` を指していることを確認

## 注意事項
- **localStorage はオリジン別**: トップページ (`auth.mtamaramu.com`) の localStorage は各アプリから見えないが、cookie (`.mtamaramu.com`) は共有されるので `recoverFromCookie()` で対応済み
- **carins の既存 WOFF 認証は後方互換**: `?woff` パラメータでの直接認証も引き続き動作する
- **SameSite=Lax**: トップレベルナビゲーション（リンククリック）では cookie が送信されるので問題なし

## 関連コミット
| リポジトリ | コミット | 内容 |
|-----------|---------|------|
| auth-worker | `ba4347a` | /top ランディングページ + recoverFromCookie + cookie Domain |
| nuxt-pwa-carins | `cb3000e` | recoverFromCookie 使用に置換 |
| nuxt-dtako-logs | `c444f97` | recoverFromCookie 追加 |
