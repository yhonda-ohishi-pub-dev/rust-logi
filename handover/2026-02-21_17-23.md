# 引き継ぎ: logout 後 WOFF login できない問題

## ステータス: cookie Domain 修正デプロイ済み / DB ドメイン不一致が残りの原因 / cookie 削除してもダメと報告あり

---

## 完了
- [x] **Cookie Domain 修正（auth-client）**: `clearStorage()` と `clearLwDomain()` で host-only cookie も削除するよう修正
  - `workers/auth-worker/packages/auth-client/src/useAuth.ts` — 57-58行, 78-79行
  - auth-worker commit: `3619627`, push 済み, auth-client v0.1.5 publish 済み
- [x] **Cookie Domain 修正（nuxt-pwa-carins サーバーミドルウェア）**: `setCookie` に `domain: getParentDomainFromHost(url.hostname)` 追加（2箇所）
  - `front/nuxt-pwa-carins/server/middleware/auth.ts` — 34行, 51行
- [x] **Cookie Domain 修正（nuxt-pwa-carins WOFF auth）**: `logi_auth_token` cookie に `Domain` 追加
  - `front/nuxt-pwa-carins/plugins/auth.client.ts` — 77行
- [x] **Cookie Domain 修正（nuxt-dtako-logs サーバーミドルウェア）**: `setCookie` に `domain` 追加
  - `front/nuxt-dtako-logs/server/middleware/auth.ts` — 41行
- [x] nuxt-pwa-carins デプロイ済み（commit `918c930`）
- [x] nuxt-dtako-logs デプロイ済み（commit `f250e33`）
- [x] **ログインページに「Cookie をクリア」ボタン追加**
  - `workers/auth-worker/src/lib/html.ts` — cookie + localStorage をクリアしてリロード
  - auth-worker commit: `1df9458`, `wrangler deploy` 済み

## 未完了
- [ ] **LINE WORKS ログインが依然として動かない** — ユーザー報告「cookie 削除してもダメ」
  - cookie クリアボタンは `auth.mtamaramu.com` ドメインの cookie のみ削除可能。`carins.mtamaramu.com` の host-only cookie は別ドメインなのでクリアできない可能性
  - `carins.mtamaramu.com` 側にもクリア手段が必要かもしれない

## 問題の全体像

### 1. Cookie Domain 不一致（修正済み・デプロイ済み）
サーバーミドルウェアが `lw_domain` cookie を `Domain` 属性なしで設定 → logout 時に `clearLwDomain()` (`Domain=.mtamaramu.com`) では host-only cookie を削除できない → stale cookie が残り自動リダイレクト

### 2. DB の external_org_id 不一致
```
DB:          external_org_id = 'ohishiunyusouko'
Bot リンク:  ?lw=ohishiunyusouko（正しい）
stale cookie: lw_domain = 'ohishi'（過去の古い Bot リンクから）
```
- `resolve_sso_provider` が `ohishi` で検索 → DB に `ohishiunyusouko` しかない → `available: false` → "not configured"
- slug フォールバック（`organizations.slug`）も空なのでマッチしない
- **slug を `ohishi` に設定する案は一度やったがユーザーに却下された**（元に戻し済み）

### 3. Cookie クリアが効かない可能性
- auth-worker のログインページ（`auth.mtamaramu.com`）の cookie クリアボタンは `auth.mtamaramu.com` ドメインの cookie しか消せない
- `carins.mtamaramu.com` に設定された host-only `lw_domain=ohishi` cookie は `auth.mtamaramu.com` からは削除不可
- ユーザーが「cookie 削除してもダメ」と言っているのはこれが原因の可能性

## 次のアクション
- [ ] **`carins.mtamaramu.com` の stale cookie を消す方法を実装**
  - 案A: nuxt-pwa-carins のサーバーミドルウェアで、OAuth が "not configured" エラーで戻ってきた場合に `lw_domain` cookie を削除する
  - 案B: nuxt-pwa-carins に cookie クリア用のエンドポイント or ページを追加
  - 案C: サーバーミドルウェアの `lw_domain` cookie 読み取り時に、`resolveSsoProvider` で事前検証してから OAuth リダイレクトする（ただしサーバーサイドから gRPC 呼び出しが必要で複雑）
- [ ] **別の可能性を調査**: cookie 以外にも原因がある可能性。LINE WORKS アプリ内ブラウザの挙動、WOFF SDK の状態なども確認が必要
- [ ] ユーザーに `carins.mtamaramu.com` で DevTools > Application > Cookies を確認してもらい、実際に何の cookie が残っているか特定する

## 関連ファイル

| ファイル | 変更内容 |
|---------|---------|
| `workers/auth-worker/packages/auth-client/src/useAuth.ts` | clearStorage/clearLwDomain に host-only cookie 削除追加 |
| `workers/auth-worker/src/lib/html.ts` | ログインページに cookie クリアボタン追加 |
| `front/nuxt-pwa-carins/server/middleware/auth.ts` | setCookie に domain 追加 |
| `front/nuxt-pwa-carins/plugins/auth.client.ts` | WOFF auth cookie に Domain 追加 |
| `front/nuxt-dtako-logs/server/middleware/auth.ts` | setCookie に domain 追加 |
| `src/services/auth_service.rs:356-427` | resolve_sso_provider — 2段階検索（direct + slug fallback） |

## 関連コミット

| リポジトリ | コミット | 内容 |
|-----------|---------|------|
| auth-worker | `3619627` | clearStorage/clearLwDomain host-only cookie 削除 |
| auth-worker | `1df9458` | ログインページ cookie クリアボタン |
| nuxt-pwa-carins | `918c930` | server middleware domain + WOFF cookie Domain |
| nuxt-dtako-logs | `f250e33` | server middleware domain + auth-client 0.1.5 |

## 注意事項
- organization slug を `ohishi` に設定する案はユーザーに却下済み。やらないこと
- DB の `sso_provider_configs`: `external_org_id = 'ohishiunyusouko'`, `woff_id = 'rlPpymIpio_7ovnX_MK7YA'`
- Bot リンク（LINE WORKS Developer Console）: `https://auth.mtamaramu.com/top?lw=ohishiunyusouko&woff`
- WOFF エンドポイント URL 変更はまだ未完了（前回 handover `2026-02-21_16-52.md` 参照）
