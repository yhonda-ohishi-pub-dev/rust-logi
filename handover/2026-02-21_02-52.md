# LINE WORKS SSO OAuth 実装（汎用SSO設計リファクタ途中）

## 概要

LINE WORKS OAuth ログインを追加する作業。途中でユーザーの要望により「LINE WORKS 専用設計」→「汎用 SSO プロバイダ設計」にリファクタリング中。**コードはコンパイルできない状態**。

## 設計計画

詳細な計画書: `/home/yhonda/.claude/plans/declarative-toasting-sphinx.md`
（※汎用SSO リファクタ前の計画なので、DB/Proto 部分は実際のコードが最新）

### 全体フロー

```
管理者: 設定画面で SSO provider config (client_id/secret + external_org_id) を登録
  ↓
ユーザー: https://auth-worker/login にアクセス
  ↓
ログインページ: 「LINE WORKS アドレスを入力」フィールド表示
  ↓
ユーザー: tanaka@ohishi を入力 → 送信
  ↓
auth-worker: "ohishi" を抽出 → ResolveSsoProvider("lineworks", "ohishi") → client_id + org情報 取得
  ↓
auth-worker → LINE WORKS authorize endpoint (該当org の client_id 使用)
  ↓
LINE WORKS 認証 → callback with code
  ↓
auth-worker → rust-logi LoginWithSsoProvider("lineworks", "ohishi", code, redirect_uri)
  ↓
rust-logi: code交換 → プロフィール取得 → 自動登録 → JWT発行
  ↓
auth-worker → フロントエンドに JWT リダイレクト（Google OAuth と同じ形式）
```

### 2つのエントリーポイント

1. **ドメイン自動判定**: `/login` → LINE WORKS アドレス入力 → @以下のドメインから組織特定
2. **org slug 指定**: `/login?org=slug` → その組織用の LINE WORKS ボタン直接表示

## 完了した作業

### Phase 1: DB マイグレーション（完了・未実行）

- `migrations/00024_create_lineworks_oauth_configs.sql` — `sso_provider_configs` テーブル作成（汎用設計済み）
  - `provider TEXT NOT NULL` — 'lineworks', 'discord', 'slack'
  - `external_org_id TEXT NOT NULL` — ドメイン/guild_id等
  - `UNIQUE(organization_id, provider)`, `UNIQUE(provider, external_org_id)`
  - NO FORCE RLS（認証前クエリ用、password_credentials と同じパターン）
- `migrations/00025_create_roles_permissions.sql` — 権限管理基盤（roles, permissions, role_permissions テーブル + 7件のシード）

**注意**: マイグレーションはまだ DB に実行していない

### Phase 2: Proto 定義（完了）

- `packages/logi-proto/proto/auth.proto` — `ResolveSsoProvider` + `LoginWithSsoProvider` RPC 追加済み
- `packages/logi-proto/proto/sso_settings.proto` — 新規作成済み（`SsoSettingsService`: GetConfig, UpsertConfig, DeleteConfig, ListConfigs）
- `build.rs` — `sso_settings.proto` 追加済み
- `src/proto/mod.rs` — `pub mod sso_settings` 追加済み

### Phase 3: Rust 実装（部分完了・コンパイル不可）

完了:
- `src/services/lineworks_auth.rs` — LINE WORKS OAuth ヘルパー + AES-256-GCM 暗号化（encrypt_secret/decrypt_secret）
- `src/services/sso_providers.rs` — 汎用 Provider enum + provider-specific endpoints/profile parsers（新規作成済み）
- `AuthServiceImpl` に `http_client: reqwest::Client` フィールド追加済み

## コンパイルできない原因（修正必要な箇所）

### 1. `src/services/auth_service.rs` — **最優先**

`AuthService` trait の `impl` に古い `resolve_lineworks_domain` と `login_with_lineworks` メソッド（行356-581）が残っている。
新しい trait が要求する `resolve_sso_provider` と `login_with_sso_provider` メソッドが未実装。

**必要な作業**:
- 行356-581の古いメソッドを削除
- `resolve_sso_provider` を実装（`sso_provider_configs` テーブルを検索、`sso_providers::build_authorize_url` を使用）
- `login_with_sso_provider` を実装（`sso_provider_configs` → decrypt → `sso_providers::exchange_code` → `sso_providers::fetch_user_profile` → 自動登録 → JWT）
- 参考: 古い `login_with_lineworks`（行414-580）のロジックはほぼそのまま使える。DB テーブル名とカラム名を `sso_provider_configs` + `provider`/`external_org_id` に変更するだけ

### 2. `src/services/lineworks_settings_service.rs` → `sso_settings_service.rs` にリネーム

現在のファイルは `crate::proto::lineworks_settings` を参照しており、削除済みの proto モジュールを指している。

**必要な作業**:
- ファイル名を `sso_settings_service.rs` にリネーム
- `use crate::proto::lineworks_settings::*` → `use crate::proto::sso_settings::*`
- `LineworksSettingsService` → `SsoSettingsService`
- `LineworksSettingsServiceImpl` → `SsoSettingsServiceImpl`
- DB クエリの `lineworks_oauth_configs` → `sso_provider_configs`
- カラム名 `lineworks_domain` → `external_org_id`
- `provider` カラムの追加（WHERE句、INSERT/UPDATE文）
- `LineworksConfigResponse` → `SsoConfigResponse`
- `ListConfigs` メソッド新規追加（proto に定義済み）

### 3. `src/services/mod.rs`

**必要な作業**:
- `pub mod sso_providers;` 追加
- `pub mod lineworks_settings_service;` → `pub mod sso_settings_service;`
- `pub use lineworks_settings_service::LineworksSettingsServiceImpl;` → `pub use sso_settings_service::SsoSettingsServiceImpl;`

### 4. `src/main.rs`

**必要な作業**:
- `use rust_logi::proto::lineworks_settings::...::LineworksSettingsServiceServer` → `use rust_logi::proto::sso_settings::...::SsoSettingsServiceServer`
- `LineworksSettingsServiceImpl` → `SsoSettingsServiceImpl`
- `LineworksSettingsServiceServer` → `SsoSettingsServiceServer`

### 5. `src/middleware/auth.rs`

**必要な作業**:
- PUBLIC_PATHS の `ResolveLineworksDomain` → `ResolveSsoProvider`
- PUBLIC_PATHS の `LoginWithLineworks` → `LoginWithSsoProvider`

### 6. `Cargo.toml`

**必要な作業**:
- `urlencoding = "2"` 依存追加（`sso_providers.rs` の `build_authorize_url` で使用）

### 7. `sso_providers.rs` と `lineworks_auth.rs` の関係整理

`sso_providers.rs` と `lineworks_auth.rs` に LINE WORKS の `exchange_code` / `fetch_user_profile` が重複している。

**推奨**:
- `lineworks_auth.rs` から `exchange_code` と `fetch_user_profile` を削除（`sso_providers.rs` に統合済み）
- `lineworks_auth.rs` は `encrypt_secret` / `decrypt_secret` のみ残す（暗号化はプロバイダ非依存）
- あるいは `lineworks_auth.rs` → `crypto.rs` にリネーム

## 未着手のフェーズ

### Phase 4: auth-worker 変更（`/home/yhonda/js/auth-worker/`）

- `src/handlers/lineworks-redirect.ts` — 新規: `/oauth/lineworks/redirect` ハンドラー
- `src/handlers/lineworks-callback.ts` — 新規: `/oauth/lineworks/callback` ハンドラー
- `src/handlers/login-page.ts` — LINE WORKS アドレス入力フィールド追加
- `src/lib/html.ts` — ログインページ HTML 更新
- `src/lib/security.ts` — state に `provider` + `external_org_id` 追加（現在 `lineworks_domain?` がある）
- `src/index.ts` — ルーティング追加
- logi-proto npm パッケージの更新が必要（新 RPC を追加したため）

### Phase 5: cf-grpc-proxy PUBLIC_PATHS 追加（`/home/yhonda/js/nuxt_dtako_logs/cf-grpc-proxy/src/index.ts`）

```
'/logi.auth.AuthService/ResolveSsoProvider'
'/logi.auth.AuthService/LoginWithSsoProvider'
```

### Phase 6: フロントエンド管理者設定画面（`/home/yhonda/js/nuxt-pwa-carins/`）

- `composables/useLineworksSettings.ts` — `SsoSettingsService` の gRPC クライアント
- `components/admin/LineworksSettings.vue` — 管理者向け SSO 設定画面

## 修正対象ファイル一覧

| ファイル | 状態 | 内容 |
|---------|------|------|
| `migrations/00024_create_lineworks_oauth_configs.sql` | 新規・完了 | sso_provider_configs テーブル |
| `migrations/00025_create_roles_permissions.sql` | 新規・完了 | 権限管理基盤 |
| `packages/logi-proto/proto/auth.proto` | 変更済み | ResolveSsoProvider + LoginWithSsoProvider |
| `packages/logi-proto/proto/sso_settings.proto` | 新規・完了 | SsoSettingsService |
| `build.rs` | 変更済み | sso_settings.proto 追加 |
| `src/proto/mod.rs` | 変更済み | sso_settings モジュール追加 |
| `src/services/sso_providers.rs` | 新規・完了 | Provider enum + endpoints + profile parsers |
| `src/services/lineworks_auth.rs` | 新規・完了 | OAuth ヘルパー + AES暗号化（重複あり要整理）|
| `src/services/auth_service.rs` | **要修正** | 古いメソッド削除 + 新メソッド実装 |
| `src/services/lineworks_settings_service.rs` | **要リネーム・修正** | → sso_settings_service.rs |
| `src/services/mod.rs` | **要修正** | sso_providers 追加、settings リネーム |
| `src/main.rs` | **要修正** | SsoSettingsServiceServer に変更 |
| `src/middleware/auth.rs` | **要修正** | PUBLIC_PATHS 更新 |
| `Cargo.toml` | **要修正** | urlencoding 依存追加 |
| auth-worker (各ファイル) | 未着手 | Phase 4 |
| cf-grpc-proxy | 未着手 | Phase 5 |
| nuxt-pwa-carins (各ファイル) | 未着手 | Phase 6 |

## git status（現在の未コミット変更）

```
 M build.rs
 M packages/logi-proto/proto/auth.proto
 M src/main.rs
 M src/middleware/auth.rs
 M src/proto/mod.rs
 M src/services/auth_service.rs
 M src/services/mod.rs
?? migrations/00024_create_lineworks_oauth_configs.sql
?? migrations/00025_create_roles_permissions.sql
?? packages/logi-proto/proto/sso_settings.proto
?? src/services/lineworks_auth.rs        (untracked)
?? src/services/lineworks_settings_service.rs  (untracked)
?? src/services/sso_providers.rs         (untracked)
```

## 次のセッションでやること

1. **コンパイル可能にする**（上記 7 箇所の修正）
2. `cargo build --release` で確認
3. Phase 4: auth-worker 変更
4. Phase 5: cf-grpc-proxy PUBLIC_PATHS
5. Phase 6: フロントエンド管理画面
6. DB マイグレーション実行
7. デプロイ・検証
