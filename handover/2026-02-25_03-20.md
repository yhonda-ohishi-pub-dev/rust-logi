# Handover: Backend 移行 Cloud SQL/Cloud Run → Supabase/Cloudflare Containers

**日時**: 2026-02-25 03:20
**計画書**: `/home/yhonda/.claude/plans/steady-finding-cray.md`

## 完了: Phase 0 — Supabase セットアップ + ローカル互換性検証

### 実施済み
- [x] Supabase プロジェクト作成（東京 ap-northeast-1、Pro $25/月）
- [x] Cloud SQL から pg_dump でデータエクスポート（256MB, FORCE RLS 一時無効化が必要だった）
- [x] Supabase にインポート（45テーブル、エラーなし）
- [x] `rust_logi_app` ユーザー作成（NOBYPASSRLS）— **重要: postgres ユーザーは BYPASSRLS=true で RLS が効かない**
- [x] `app_user`, `app_admin` カスタムロール作成
- [x] RLS + set_config 動作確認 OK（org未設定→0件、設定後→220件）
- [x] ローカル rust-logi を Supabase 接続で起動、主要 RPC 全動作確認
- [x] CLAUDE.md 更新済み

### Supabase 接続情報
- プロジェクト: `https://tvbjvhvslgdwwlhpkezh.supabase.co`
- **アプリ接続**: `postgresql://rust_logi_app:Zo6hYIWs7yH0sTah@db.tvbjvhvslgdwwlhpkezh.supabase.co:5432/postgres`
- **管理接続**: `postgresql://postgres:Zo6hYIWs7yH0sTah@db.tvbjvhvslgdwwlhpkezh.supabase.co:5432/postgres`
- `.env` に `SUPABASE_DATABASE_URL` として記載済み

### 重要な発見
1. **Supabase の postgres ユーザーは BYPASSRLS=true** → `rust_logi_app`（NOBYPASSRLS）で接続必須
2. **Supavisor transaction mode (port 6543) は使用不可** — set_config がリセットされる
3. **pg_dump 時は FORCE RLS を一時無効化が必要** — postgres ユーザーでもブロックされる
4. **マイグレーション実行は postgres ユーザーで** — DDL には権限が必要

### ダンプファイル
- `/home/yhonda/rust/rust-logi/supabase_migration.sql` (256MB) — 不要なら削除可

## 完了: Phase 1 — Cloud Run → Supabase デプロイ + ベンチマーク

### 実施済み
- [x] Secret Manager `rust-logi-database-url` を Supabase URL に更新（version 3）
- [x] `deploy.sh` 修正: `--add-cloudsql-instances` → `--clear-cloudsql-instances`
- [x] Cloud Run デプロイ: revision `rust-logi-00119-jrp` (SERVING)
- [x] ベンチマーク実施

### ベンチマーク結果: PASS

| RPC | Cloud SQL 中央値 | Supabase 中央値 | 差分 |
|-----|-----------------|----------------|------|
| ListCurrentCarInspections | 347ms | 313ms | **-34ms (速い)** |
| ListFiles | 320ms | 331ms | **+11ms** |

判定: p95 +20ms 以内の基準を満たす。Supabase 東京リージョンは Cloud SQL と同等性能。

### ロールバック手順（Cloud SQL に戻す場合）
```bash
# 1. Secret を Cloud SQL に戻す
echo -n "postgres://postgres:kikuraku@localhost/rust_logi_test?host=/cloudsql/cloudsql-sv:asia-northeast1:postgres-prod" | \
  gcloud secrets versions add rust-logi-database-url --data-file=-
# 2. deploy.sh の --clear-cloudsql-instances を --add-cloudsql-instances cloudsql-sv:asia-northeast1:postgres-prod に戻す
# 3. ./deploy.sh
```

## 次のタスク: Phase 2 — ストレージ抽象化（GCS/R2 両対応）

### やること
1. `StorageBackend` trait 定義 (`src/storage/mod.rs`)
2. 既存 GcsClient を trait impl に (`src/storage/gcs.rs`)
3. R2 クライアント新規作成 (`src/storage/r2.rs`) — aws-sdk-s3 使用
4. `STORAGE_BACKEND=gcs|r2` 環境変数で切り替え (`src/config.rs`)
5. サービス層を `Box<dyn StorageBackend>` 経由に変更
6. R2 バケット作成 + GCS → R2 データコピー (rclone)
7. テスト: Cloud Run + R2 で CreateFile/DownloadFile 動作確認

### 残りの Phase
- Phase 3: Cloudflare Containers セットアップ
- Phase 4: フロントエンド E2E 検証
- Phase 5: クリーンアップ + 本番切り替え
