# 引き継ぎ: LINE WORKS Bot リッチメニュー管理画面（マルチテナント対応）

## ステータス: DB/Proto/Rust 完了・auth-worker 実装途中

---

## 設計変更（前回プランからの変更点）

ユーザー要望により、Bot credentials を env vars ではなく **DB に保存してマルチテナント・複数 Bot 対応** に変更。

- 新規 `bot_configs` テーブル（sso_provider_configs とは別管理）
- 新規 `BotConfigService` gRPC サービス（CRUD + secrets 復号）
- auth-worker の `lineworks-bot-api.ts` は `BotCredentials` インターフェースで credentials を受け取る形に変更（Env 直接参照やめた）
- Bot 設定 UI は admin-sso ページに追加予定
- Rich Menu 管理画面で Bot を選択してからメニュー操作する

## 完了

- [x] マイグレーション作成 — `migrations/00027_create_bot_configs.sql`
  - organization_id, provider, name, client_id, client_secret_encrypted, service_account, private_key_encrypted, bot_id, enabled
  - RLS (FORCE) + UNIQUE(provider, bot_id)
- [x] Proto 作成 — `packages/logi-proto/proto/bot_config.proto`
  - BotConfigService: ListConfigs, GetConfig, UpsertConfig, DeleteConfig, GetConfigWithSecrets
  - GetConfigWithSecrets は secrets を復号して返す（Rich Menu API 呼び出し用）
- [x] Rust サービス実装 — `src/services/bot_config_service.rs`
  - 既存 `lineworks_auth::encrypt_secret` / `decrypt_secret` (AES-256-GCM) を流用
  - `src/services/mod.rs`, `src/proto/mod.rs`, `src/main.rs`, `build.rs` にサービス登録済み
  - `cargo build` 成功確認済み
- [x] logi-proto TypeScript 生成・ビルド — `packages/logi-proto/src/gen/bot_config_pb.ts`
  - `npm run build` 成功、`dist/` に bot_config_pb 含む
  - auth-worker に `npm install` 済み
- [x] `lineworks-bot-api.ts` リファクタ — Env 依存から `BotCredentials` インターフェースに変更
  - JWT 生成（Web Crypto API, RS256）+ OAuth2 + Rich Menu API ラッパー 7 関数
  - Env の `LW_BOT_*` フィールドは削除済み
- [x] `api-bot-config.ts` 作成 — Bot Config CRUD の API ハンドラ
  - handleBotConfigList, handleBotConfigUpsert, handleBotConfigDelete

## 未完了

- [ ] **Rich Menu API ハンドラ作成** — `auth-worker/src/handlers/api-rich-menu.ts`
  - `handleRichMenuList`, `handleRichMenuCreate`, `handleRichMenuDelete`
  - `handleRichMenuImage`, `handleRichMenuDefaultSet/Get/Delete`
  - 各ハンドラで: Bearer token 検証 → gRPC `GetConfigWithSecrets` で Bot credentials 取得 → `lineworks-bot-api.ts` 呼び出し
- [ ] **admin-sso ページに Bot 設定 UI 追加** — `auth-worker/src/lib/admin-html.ts`
  - Bot 一覧表示、追加/編集フォーム（name, clientId, clientSecret, serviceAccount, privateKey, botId）
  - API: `/api/bot-config/list`, `/api/bot-config/upsert`, `/api/bot-config/delete`
- [ ] **Rich Menu 管理画面 HTML** — `auth-worker/src/lib/admin-rich-menu-html.ts` 新規作成
  - Bot 選択 → メニュー一覧、作成フォーム、画像アップロード、デフォルト設定
- [ ] **ページハンドラ** — `auth-worker/src/handlers/admin-rich-menu.ts` 新規作成
  - handleAdminRichMenuPage, handleAdminRichMenuCallback
- [ ] **ルーティング追加** — `auth-worker/src/index.ts`
  - GET: `/admin/rich-menu`, `/admin/rich-menu/callback`
  - POST: `/api/bot-config/list`, `/api/bot-config/upsert`, `/api/bot-config/delete`
  - POST: `/api/richmenu/list`, `/api/richmenu/create`, `/api/richmenu/delete`, `/api/richmenu/image`, `/api/richmenu/default/set`, `/api/richmenu/default/get`, `/api/richmenu/default/delete`
- [ ] **マイグレーション実行** — `sqlx migrate run`
- [ ] **rust-logi デプロイ** — BotConfigService を含む新バイナリ
- [ ] **logi-proto パッケージ publish** — GitHub Packages（git push で pre-push hook が自動実行）
- [ ] **auth-worker デプロイ** — `wrangler deploy`
- [ ] **動作確認** — 管理画面から Bot 登録 → Rich Menu 作成 → LINE WORKS モバイルで表示確認

## 次のアクション

- [ ] プランファイル参照 — `/home/yhonda/.claude/plans/ethereal-whistling-toast.md`（元プラン）+ `/home/yhonda/.claude/plans/hazy-launching-dongarra.md`（前回承認プラン）
- [ ] API 仕様参照 — `docs/lineworks-rich-menu-api.md`
- [ ] `api-rich-menu.ts` 実装 — `auth-worker/src/handlers/api-rich-menu.ts` を新規作成
  - 各ハンドラで `BotConfigService.GetConfigWithSecrets` → `BotCredentials` → Rich Menu API 呼び出し
- [ ] 参考コード: `auth-worker/src/handlers/api-sso.ts`（API ハンドラパターン）
- [ ] 参考コード: `auth-worker/src/handlers/api-bot-config.ts`（Bot Config ハンドラ、今回作成済み）
- [ ] 参考コード: `auth-worker/src/lib/admin-html.ts`（SPA HTML パターン）
- [ ] 参考コード: `auth-worker/src/handlers/admin-sso.ts`（ページハンドラパターン）

## 注意事項

- **マイグレーション 00027 は未実行** — `sqlx migrate run` が必要
- **rust-logi は未デプロイ** — BotConfigService を含むビルドは成功済みだが Cloud Run にはデプロイしていない
- **logi-proto は未 publish** — ローカルの `npm install` で auth-worker にインストール済みだが GitHub Packages には未 publish
- **暗号化**: client_secret と private_key は AES-256-GCM で暗号化（鍵は `JWT_SECRET` 環境変数、SHA-256 導出）
- **RLS**: bot_configs テーブルは FORCE RLS が有効 → gRPC ハンドラで `set_current_organization` 必須（BotConfigService で対応済み）
- **画像アップロードは 3 ステップ**: POST /attachments → PUT uploadUrl → POST /richmenus/{id}/image
- **画像要件**: JPEG/PNG, 2500x843 or 2500x1686, max 1MB

## 変更ファイル一覧

### rust-logi（Rust）
| ファイル | 操作 | 状態 |
|---------|------|------|
| `migrations/00027_create_bot_configs.sql` | 新規 | 未実行 |
| `packages/logi-proto/proto/bot_config.proto` | 新規 | 完了 |
| `packages/logi-proto/src/gen/bot_config_pb.ts` | 自動生成 | 完了 |
| `packages/logi-proto/src/index.ts` | 変更 | 完了 |
| `src/services/bot_config_service.rs` | 新規 | 完了 |
| `src/services/mod.rs` | 変更 | 完了 |
| `src/proto/mod.rs` | 変更 | 完了 |
| `src/main.rs` | 変更 | 完了 |
| `build.rs` | 変更 | 完了 |

### auth-worker（TypeScript）
| ファイル | 操作 | 状態 |
|---------|------|------|
| `src/lib/lineworks-bot-api.ts` | 新規 | 完了 |
| `src/handlers/api-bot-config.ts` | 新規 | 完了 |
| `src/handlers/api-rich-menu.ts` | 新規 | **未着手** |
| `src/handlers/admin-rich-menu.ts` | 新規 | **未着手** |
| `src/lib/admin-rich-menu-html.ts` | 新規 | **未着手** |
| `src/lib/admin-html.ts` | 変更 | **未着手**（Bot 設定 UI 追加） |
| `src/index.ts` | 変更 | **未着手**（ルーティング追加） |
