# 引き継ぎ: WOFF SDK Integration for LINE WORKS Auto-Login

## ステータス: Phase 1-3 コード実装済み / Phase 4 途中 / WOFF IDマルチテナント問題が発覚

---

## 背景

LINE WORKSアプリ内（WOFF container）でBot送信のリンクを開くと、OAuthリダイレクトフローが起動しLINE WORKS OAuth同意画面が表示されてしまう。WOFF SDKを使えばWOFFコンテナ内で既に認証済みのためシームレスなログインが可能。

## 重要: WOFF IDはマルチテナントではない

**WOFF IDはLINE WORKSドメイン（テナント）ごとに必要。** 現在の設計では `NUXT_PUBLIC_WOFF_ID` を1つだけ `wrangler.toml` に持つ想定だったが、複数テナント（例: ohishiunyusouko, 他のドメイン）をサポートするには設計変更が必要。

### 解決案
1. **WOFF IDをDB（`sso_provider_configs`テーブル）に格納** — テナントごとにWOFF IDを持つ
2. **フロントエンドからのWOFF ID取得フロー変更** — WOFFコンテナ内ではドメイン名からWOFF IDを解決する必要がある
3. **または**: Bot がテナント固有のWOFF URLを送信（`https://woff.worksmobile.com/woff/v2/{テナント固有WOFF_ID}`）し、WOFF container自体がテナントを識別

---

## 完了
- [x] `packages/logi-proto/proto/auth.proto` — `LoginWithSsoProviderRequest` に `access_token` フィールド(field 5)追加
- [x] TypeScript再生成 (`npm run generate` + `npm run build`) 完了
- [x] Rust再生成 (`cargo build`) 完了
- [x] `src/services/auth_service.rs` — `login_with_sso_provider` を修正: `access_token` がある場合はコード交換をスキップ
- [x] `auth-worker/src/handlers/woff-auth.ts` — 新規作成: `POST /auth/woff` ハンドラー
- [x] `auth-worker/src/index.ts` — `/auth/woff` ルート追加 + CORS preflight対応
- [x] auth-worker `wrangler deploy --dry-run` ビルド成功確認
- [x] `nuxt-pwa-carins/types/woff.d.ts` — WOFF SDK型定義ファイル作成
- [x] `nuxt-pwa-carins/nuxt.config.ts` — WOFF SDK CDNスクリプト追加 + `woffId` runtimeConfig追加
- [x] `nuxt-pwa-carins/wrangler.toml` — `NUXT_PUBLIC_WOFF_ID` プレースホルダー追加

## 未完了
- [ ] **WOFF IDマルチテナント設計を再検討** — 1つのWOFF IDでは複数テナントに対応できない
  - `sso_provider_configs` テーブルに `woff_id` カラムを追加する案
  - フロントエンドでのWOFF ID解決フロー設計
  - BotがテナントごとにWOFF URLを送る設計にすれば、フロントエンドはWOFF container内のprofileからdomainIdを取得しDB lookupで対応可能
- [ ] **`plugins/auth.client.ts` のWOFF認証フロー実装** — 現在の `?lw=` OAuth フローの前にWOFF検出・認証を挿入
- [ ] **WOFF App登録**（手動作業） — LINE WORKS Developer ConsoleでWOFFアプリ登録、WOFF ID取得
- [ ] **デプロイ** — rust-logi → logi-proto publish → auth-worker → nuxt-pwa-carins
- [ ] **動作検証** — LINE WORKSアプリ内でWOFF URLを開き、同意画面なしで認証されることを確認

## 次のアクション

### 1. マルチテナント対応の設計決定
BotがテナントごとのWOFF URLを送る方式が最もシンプル:
```
Bot → ユーザー: https://woff.worksmobile.com/woff/v2/{テナント固有WOFF_ID}
WOFF container起動 → nuxt-pwa-carins ロード
woff.init({woffId}) ← このwoffIdをどう取得するか?
```

**案A**: WOFF container URLにはWOFF IDが含まれているので、WOFF SDK内部で自動設定される（要検証）
**案B**: `sso_provider_configs` に `woff_id` カラムを追加し、`ResolveSsoProvider` RPCで返す
**案C**: フロントエンドで固定WOFF IDを使い、`woff.getProfile().domainId` でテナント識別

### 2. DB変更（案Bの場合）
```sql
ALTER TABLE sso_provider_configs ADD COLUMN woff_id TEXT;
```

### 3. `plugins/auth.client.ts` 修正
WOFFコンテナ検出 → WOFF認証のフロー:
```typescript
// WOFF SDKが存在し、WOFFコンテナ内かチェック
if (typeof woff !== 'undefined') {
  await woff.init({ woffId })  // ← マルチテナント対応のwoffId取得方法要検討
  if (woff.isInClient()) {
    const accessToken = woff.getAccessToken()
    const profile = await woff.getProfile()
    // POST /auth/woff → JWT取得
  }
}
```

## 変更済みファイル一覧

| リポジトリ | ファイル | 状態 |
|------------|----------|------|
| rust-logi | `packages/logi-proto/proto/auth.proto` | 変更済み |
| rust-logi | `src/services/auth_service.rs` | 変更済み |
| auth-worker | `src/handlers/woff-auth.ts` | 新規作成 |
| auth-worker | `src/index.ts` | 変更済み |
| nuxt-pwa-carins | `types/woff.d.ts` | 新規作成 |
| nuxt-pwa-carins | `nuxt.config.ts` | 変更済み |
| nuxt-pwa-carins | `wrangler.toml` | 変更済み |
| nuxt-pwa-carins | `plugins/auth.client.ts` | **未変更**（WOFF認証フロー未実装） |

## 注意事項

- auth-workerの `package.json` で `logi-proto` を一時的にローカルパスに変更した後、`@latest` に戻した。デプロイ前に logi-proto の npm publish が必要（rust-logiの `git push` で pre-push hookが自動publish）
- `woff.getProfile().domainId` が文字列(ドメイン名)か数値(ドメインID)かは未検証。実装時に確認が必要
- `woff.getAccessToken()` がLINE WORKS user API (`/v1.0/users/me`) で使えるかも未検証
- 計画ファイル: `/home/yhonda/.claude/plans/velvety-prancing-salamander.md`（WOFF IDマルチテナント問題は未反映）
